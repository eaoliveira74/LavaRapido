(function(){const x=document.createElement("link").relList;if(x&&x.supports&&x.supports("modulepreload"))return;for(const E of document.querySelectorAll('link[rel="modulepreload"]'))ee(E);new MutationObserver(E=>{for(const w of E)if(w.type==="childList")for(const P of w.addedNodes)P.tagName==="LINK"&&P.rel==="modulepreload"&&ee(P)}).observe(document,{childList:!0,subtree:!0});function U(E){const w={};return E.integrity&&(w.integrity=E.integrity),E.referrerPolicy&&(w.referrerPolicy=E.referrerPolicy),E.crossOrigin==="use-credentials"?w.credentials="include":E.crossOrigin==="anonymous"?w.credentials="omit":w.credentials="same-origin",w}function ee(E){if(E.ep)return;E.ep=!0;const w=U(E);fetch(E.href,w)}})();document.addEventListener("DOMContentLoaded",()=>{let b=JSON.parse(localStorage.getItem("services"))||[{id:"lavagem-simples",nome:"Lavagem Simples",preco:15,duration:30},{id:"lavagem-completa",nome:"Lavagem Completa",preco:25,duration:60},{id:"enceramento",nome:"Enceramento",preco:40,duration:90},{id:"lavagem-motor",nome:"Lavagem do Motor",preco:30,duration:45}],x=[];const U=[];(()=>{for(let n=480;n<=1020;n+=30){const s=Math.floor(n/60).toString().padStart(2,"0"),i=(n%60).toString().padStart(2,"0");U.push(`${s}:${i}`)}})();let E=null,w=localStorage.getItem("adminToken")||null;const P=e=>{w=e,e?localStorage.setItem("adminToken",e):localStorage.removeItem("adminToken")};let L=null,C=null;const me=document.getElementById("role-selection-view"),ue=document.getElementById("client-view"),pe=document.getElementById("admin-view"),j=document.getElementById("logout-button"),ge=document.getElementById("announcement-container"),O=document.getElementById("date-picker"),te=document.getElementById("available-times-grid"),Ne=document.getElementById("available-times-title"),he=document.getElementById("appointment-form"),z=document.getElementById("servicoId"),k=document.getElementById("horario"),K=document.getElementById("completion-time-alert");document.getElementById("admin-appointments-section"),document.getElementById("admin-services-section");const V=document.getElementById("appointments-table-body"),ne=document.getElementById("services-list"),oe=document.getElementById("service-form"),He=document.getElementById("whatsapp-modal"),fe=new bootstrap.Modal(He),Re=document.getElementById("whatsapp-client-name"),ve=document.getElementById("whatsapp-message"),Pe=document.getElementById("send-whatsapp-btn"),ae=()=>{localStorage.setItem("services",JSON.stringify(b))},f=(e,t="success")=>{ge.innerHTML=`<div class="alert alert-${t}" role="alert">${e}</div>`,setTimeout(()=>{ge.innerHTML=""},5e3)},S=()=>{const e=new Date,t=e.getTimezoneOffset();return new Date(e.getTime()-t*60*1e3).toISOString().split("T")[0]},N=e=>{me.classList.add("d-none"),ue.classList.add("d-none"),pe.classList.add("d-none"),j.classList.add("d-none"),e==="client"?(ue.classList.remove("d-none"),j.classList.remove("d-none"),Oe()):e==="admin"?(pe.classList.remove("d-none"),j.classList.remove("d-none"),H()):me.classList.remove("d-none")},Oe=()=>{Fe(),W().then(()=>J()).catch(()=>J())};W().catch(()=>{});const H=(e="appointments")=>{w&&q().catch(()=>{}),F(),Ue(),document.getElementById("admin-appointments-section").classList.toggle("d-none",e!=="appointments"),document.getElementById("admin-services-section").classList.toggle("d-none",e!=="services"),document.getElementById("admin-stats-section").classList.toggle("d-none",e!=="stats"),document.getElementById("show-appointments-btn").classList.toggle("btn-cyan",e==="appointments"),document.getElementById("show-appointments-btn").classList.toggle("btn-secondary",e!=="appointments"),document.getElementById("show-services-btn").classList.toggle("btn-cyan",e==="services"),document.getElementById("show-services-btn").classList.toggle("btn-secondary",e!=="services");const t=document.getElementById("show-stats-btn");t&&(t.classList.toggle("btn-cyan",e==="stats"),t.classList.toggle("btn-outline-light",e!=="stats")),e==="stats"&&Ke()},q=async()=>{const e=window.__BACKEND_URL__||"http://localhost:4000";if(w)try{const t=await fetch(`${e}/api/appointments`,{headers:{Authorization:`Bearer ${w}`}});if(!t.ok){L=null;const n=await t.text().catch(()=>"");f(`Falha ao carregar agendamentos: ${n||t.status}`,"danger");return}L=await t.json(),F()}catch{L=null,f("N√£o foi poss√≠vel conectar ao servidor para listar agendamentos.","warning")}},W=async()=>{try{const e=window.__BACKEND_URL__||"http://localhost:4000",t=await fetch(`${e}/api/appointments/public`);if(!t.ok){C=null;return}C=await t.json(),F()}catch{C=null}},Fe=()=>{z.innerHTML='<option value="">Selecione um servi√ßo</option>',b.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.nome} - R$ ${e.preco.toFixed(2)} (${e.duration} min)`,z.appendChild(t)})},J=()=>{const e=O.value,t=new Date(e+"T00:00:00").toLocaleDateString("pt-BR");Ne.textContent=`Hor√°rios para ${t}`;const n=C||x,s=new Set((n||[]).filter(i=>i.data===e&&i.status!=="Cancelado").map(i=>i.horario));te.innerHTML="",k.innerHTML='<option value="">Selecione um hor√°rio</option>',U.forEach(i=>{const o=s.has(i),c=document.createElement("div");if(c.className=`slot p-2 rounded text-center small ${o?"reserved":"free"}`,c.dataset.time=i,c.innerHTML=`<div class="slot-label fw-bold">${i}</div>`,te.appendChild(c),!o){const r=document.createElement("option");r.value=i,r.textContent=i,k.appendChild(r)}}),te.querySelectorAll(".slot").forEach(i=>i.addEventListener("click",()=>{const o=i.dataset.time;k.querySelector(`option[value="${o}"]`)&&(k.value=o,k.dispatchEvent(new Event("change")))}))},F=()=>{V.innerHTML="";const e=w&&L?L:C||x;if(!e||e.length===0){V.innerHTML='<tr><td colspan="7" class="text-center text-secondary">Nenhum agendamento encontrado.</td></tr>';return}[...e].sort((n,s)=>new Date(n.data).getTime()-new Date(s.data).getTime()||(n.horario||"").localeCompare(s.horario||"")).forEach(n=>{const s=b.find(c=>c.id===n.servicoId),i={Pendente:"text-warning",Confirmado:"text-primary",Cancelado:"text-danger",Conclu√≠do:"text-success fw-bold"},o=document.createElement("tr");o.innerHTML=`
              <td>${new Date(n.data+"T00:00:00").toLocaleDateString("pt-BR")}</td>
              <td>${n.horario}</td>
              <td>${n.nomeCliente}</td>
              <td>${s?s.nome:"N/A"}</td>
              <td>${n.observacoes||"Nenhuma"}</td>
              <td class="${i[n.status]||""}">${n.status}</td>
              <td>
                  ${n.comprovanteDataUrl||n.comprovantePath?`<button class="btn btn-sm btn-outline-info me-1" data-action="view-proof" data-id="${n.id}">Ver Comprovante</button>`:""}
                  <div class="d-inline-flex flex-wrap gap-1">
                      <button class="btn btn-sm btn-info" data-action="notify" data-id="${n.id}">Notificar</button>
                      <button class="btn btn-sm ${n.status==="Conclu√≠do"?"btn-success":"btn-outline-success"}" data-action="complete" data-id="${n.id}">Conclu√≠do</button>
                      <button class="btn btn-sm btn-outline-primary" data-action="keep" data-id="${n.id}">Manter</button>
                      <button class="btn btn-sm btn-outline-warning" data-action="pendent" data-id="${n.id}">Pendente</button>
                      <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${n.id}">Excluir</button>
                  </div>
              </td>
          `,V.appendChild(o)})},Ue=()=>{ne.innerHTML="",b.forEach(e=>{const t=document.createElement("li");t.className="list-group-item d-flex justify-content-between align-items-center",t.innerHTML=`
              <div>
                  ${e.nome} (${e.duration} min)
                  <small class="d-block text-secondary">R$ ${e.preco.toFixed(2)}</small>
              </div>
              <div>
                  <button class="btn btn-sm btn-outline-primary me-1" data-action="edit-service" data-id="${e.id}">Editar</button>
                  <button class="btn btn-sm btn-outline-danger" data-action="delete-service" data-id="${e.id}">Excluir</button>
              </div>
          `,ne.appendChild(t)})};document.getElementById("select-client-role").addEventListener("click",()=>N("client")),document.getElementById("select-admin-role").addEventListener("click",()=>{const e=document.getElementById("admin-password-modal"),t=new bootstrap.Modal(e);document.getElementById("admin-password-input").value="",document.getElementById("admin-password-feedback").classList.add("d-none"),t.show()}),j.addEventListener("click",()=>N(null)),document.getElementById("show-appointments-btn").addEventListener("click",()=>H("appointments")),document.getElementById("show-services-btn").addEventListener("click",()=>H("services"));const ye=document.getElementById("show-stats-btn");ye&&ye.addEventListener("click",()=>H("stats")),O.addEventListener("change",J),[z,k].forEach(e=>{e.addEventListener("change",()=>{const t=z.value,n=k.value;if(!t||!n){K.classList.add("d-none");return}const s=b.find(h=>h.id===t),[i,o]=n.split(":").map(Number),c=i*60+o+s.duration,r=Math.floor(c/60)%24,a=c%60,u=`${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`;K.textContent=`Previs√£o de t√©rmino: ${u}`,K.classList.remove("d-none")})}),he.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("comprovante"),n=t&&t.files&&t.files[0],s={nomeCliente:document.getElementById("nomeCliente").value,telefoneCliente:document.getElementById("telefoneCliente").value,servicoId:document.getElementById("servicoId").value,data:O.value,horario:document.getElementById("horario").value,observacoes:document.getElementById("observacoes").value},i=new FormData;i.append("nomeCliente",s.nomeCliente),i.append("telefoneCliente",s.telefoneCliente),i.append("servicoId",s.servicoId),i.append("data",s.data),i.append("horario",s.horario),i.append("observacoes",s.observacoes||""),n&&i.append("comprovante",n,n.name);const o=(window.__BACKEND_URL__||"http://localhost:4000")+"/api/appointments";fetch(o,{method:"POST",body:i}).then(async c=>{if(!c.ok){let r=`Erro ao enviar (HTTP ${c.status})`;try{const a=await c.json();a&&a.error?r=a.error:typeof a=="string"&&(r=a)}catch{try{const u=await c.text();u&&(r=u)}catch{}}if(f(r,"danger"),c.status>=400&&c.status<500)return null;throw new Error(r)}return c.json()}).then(async c=>{if(!c)return;c.comprovantePath&&(c.comprovantePath=c.comprovantePath.replace(/\\/g,"/")),await W(),f(`Agendamento para ${c.nomeCliente} realizado com sucesso (enviado ao servidor).`),he.reset(),t.value="";const r=document.getElementById("comprovante-status");r&&(r.textContent=""),K.classList.add("d-none"),J(),F()}).catch(c=>{console.warn("Falha ao enviar para o servidor:",c),f(`Erro ao conectar ao servidor: ${c.message||"Tente novamente mais tarde."}`,"danger")})});const Y=document.getElementById("comprovante");Y&&Y.addEventListener("change",()=>{const e=document.getElementById("comprovante-status"),t=Y.files&&Y.files[0];e&&(t?e.textContent=`${t.name} ‚Äî arquivo selecionado`:e.textContent="")}),V.addEventListener("click",async e=>{var c;const t=e.target,n=t.dataset.action,s=t.dataset.id;if(!n)return;const o=(w&&L?L:C||x).find(r=>String(r.id)===String(s));if(n==="view-proof"){const r=window.__BACKEND_URL__||"http://localhost:4000";if(o&&o.comprovantePath)try{const a=`${r.replace(/\/$/,"")}/${o.comprovantePath.replace(/^\//,"")}`;window.open(a,"_blank");return}catch{}if(w&&o&&o.comprovantePath)try{const a=await fetch(`${r}/api/appointments/${s}/comprovante`,{headers:{Authorization:`Bearer ${w}`}});if(!a.ok){f("Falha ao baixar comprovante.","danger");return}const u=await a.blob(),h=URL.createObjectURL(u);window.open(h,"_blank"),setTimeout(()=>URL.revokeObjectURL(h),6e4);return}catch{f("Erro ao baixar comprovante.","danger")}o&&o.comprovanteDataUrl?window.open(o.comprovanteDataUrl,"_blank"):f("N√£o h√° comprovante dispon√≠vel para este agendamento.","warning")}else if(n==="notify"){E=o;const r=((c=b.find(u=>u.id===o.servicoId))==null?void 0:c.nome)||"servi√ßo",a=`Ol√° ${o.nomeCliente}, passando para confirmar seu agendamento de ${r} para o dia ${new Date(o.data+"T00:00:00").toLocaleDateString("pt-BR")} √†s ${o.horario}.`;Re.textContent=o.nomeCliente,ve.value=a,fe.show()}else if(n==="complete"){if(!w){f("A√ß√£o dispon√≠vel apenas para administradores. Fa√ßa login.","warning");return}try{const r=window.__BACKEND_URL__||"http://localhost:4000";if(!(await fetch(`${r}/api/appointments/${s}/confirm`,{method:"POST",headers:{Authorization:`Bearer ${w}`}})).ok){f("Falha ao atualizar status no servidor.","danger");return}f("Agendamento atualizado no servidor."),await q()}catch{f("Erro ao comunicar com o servidor.","danger")}}else if(n==="keep"){if(!w){f("A√ß√£o dispon√≠vel apenas para administradores. Fa√ßa login.","warning");return}try{const r=window.__BACKEND_URL__||"http://localhost:4000";if(!(await fetch(`${r}/api/appointments/${s}/confirm`,{method:"POST",headers:{Authorization:`Bearer ${w}`}})).ok){f("Falha ao confirmar agendamento.","danger");return}f("Agendamento confirmado no servidor."),await q()}catch{f("Erro ao confirmar agendamento.","danger")}}else if(n==="pendent"){if(!w){f("A√ß√£o dispon√≠vel apenas para administradores. Fa√ßa login.","warning");return}f("Para marcar como Pendente, use o painel do administrador.")}else if(n==="delete"&&confirm(`Tem certeza que deseja excluir o agendamento de ${o.nomeCliente}?`))if(w)try{const r=window.__BACKEND_URL__||"http://localhost:4000";if(!(await fetch(`${r}/api/appointments/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${w}`}})).ok){f("Falha ao excluir agendamento no servidor.","danger");return}f("Agendamento exclu√≠do no servidor.","success"),await q()}catch{f("Erro ao excluir agendamento.","danger")}else{f("A√ß√£o dispon√≠vel apenas para administradores. Fa√ßa login.","warning");return}ae(),F();try{renderClientAppointments()}catch{}}),Pe.addEventListener("click",()=>{if(!E)return;const e=ve.value,n=`https://wa.me/55${E.telefoneCliente.replace(/\D/g,"")}?text=${encodeURIComponent(e)}`;window.open(n,"_blank"),fe.hide(),E=null}),ne.addEventListener("click",e=>{const t=e.target,n=t.dataset.action,s=t.dataset.id;if(!n)return;const i=b.find(o=>o.id===s);n==="edit-service"?(document.getElementById("service-id-hidden").value=i.id,document.getElementById("serviceName").value=i.nome,document.getElementById("servicePrice").value=i.preco.toString(),document.getElementById("serviceDuration").value=i.duration.toString(),document.getElementById("service-form-title").textContent="Editar Servi√ßo",document.getElementById("service-form-submit-btn").textContent="Salvar",document.getElementById("service-form-cancel-btn").classList.remove("d-none")):n==="delete-service"&&confirm(`Tem certeza que deseja excluir o servi√ßo "${i.nome}"?`)&&(b=b.filter(o=>o.id!==s),ae(),f(`Servi√ßo "${i.nome}" exclu√≠do.`,"danger"),H("services"))}),document.getElementById("admin-stats-section");const je=document.getElementById("stats-range"),se=document.getElementById("stats-date"),we=document.getElementById("stats-refresh"),ze=document.getElementById("stats-chart"),Ee=document.getElementById("stats-weather");let A=null;se&&(se.value=S());const G="statsLastCep_v1";try{const e=localStorage.getItem(G),t=document.getElementById("stats-cep");e&&t&&(t.value=e)}catch{}async function Ke(){typeof Chart>"u"&&await Ve("https://cdn.jsdelivr.net/npm/chart.js"),await Le()}function Ve(e){return new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=t,s.onerror=n,document.head.appendChild(s)})}function qe(e,t,n){const s=new Date(t+"T00:00:00"),i=new Map,o=new Map,c=[],r=a=>{c.push(a),i.set(a,0),o.set(a,0)};if(e==="day"){const a=s.toLocaleDateString("pt-BR");r(a),(n||[]).forEach(u=>{var h;if(u.data===t&&u.status!=="Cancelado"){i.set(a,i.get(a)+1);const p=((h=b.find(l=>l.id===u.servicoId))==null?void 0:h.preco)||0;o.set(a,o.get(a)+p)}})}else if(e==="week"){const a=new Date(s),h=(a.getDay()+6)%7;a.setDate(a.getDate()-h);for(let p=0;p<7;p++){const l=new Date(a);l.setDate(a.getDate()+p);const d=l.toLocaleDateString("pt-BR");r(d)}(n||[]).forEach(p=>{var d;if(p.status==="Cancelado")return;const l=c.indexOf(new Date(p.data+"T00:00:00").toLocaleDateString("pt-BR"));if(l>=0){const m=c[l];i.set(m,i.get(m)+1);const g=((d=b.find(v=>v.id===p.servicoId))==null?void 0:d.preco)||0;o.set(m,o.get(m)+g)}})}else if(e==="month"){const a=s.getFullYear(),u=s.getMonth(),h=new Date(a,u+1,0).getDate();for(let p=1;p<=h;p++){const d=new Date(a,u,p).toLocaleDateString("pt-BR");r(d)}(n||[]).forEach(p=>{var d;if(p.status==="Cancelado")return;const l=c.indexOf(new Date(p.data+"T00:00:00").toLocaleDateString("pt-BR"));if(l>=0){const m=c[l];i.set(m,i.get(m)+1);const g=((d=b.find(v=>v.id===p.servicoId))==null?void 0:d.preco)||0;o.set(m,o.get(m)+g)}})}else if(e==="year"){const a=s.getFullYear();for(let u=0;u<12;u++){const p=new Date(a,u,1).toLocaleString("pt-BR",{month:"short"});r(p)}(n||[]).forEach(u=>{var p;if(u.status==="Cancelado")return;const h=new Date(u.data+"T00:00:00");if(h.getFullYear()===a){const l=new Date(h.getFullYear(),h.getMonth(),1).toLocaleString("pt-BR",{month:"short"});i.set(l,(i.get(l)||0)+1);const d=((p=b.find(m=>m.id===u.servicoId))==null?void 0:p.preco)||0;o.set(l,(o.get(l)||0)+d)}})}return{labels:c,counts:c.map(a=>i.get(a)||0),revenue:c.map(a=>o.get(a)||0)}}async function be(e){if(!e)return null;const t=(e||"").toString().replace(/\D/g,"");if(t.length<8)return null;try{const n=`https://viacep.com.br/ws/${t}/json/`,s=await fetch(n);if(!s.ok)return null;const i=await s.json();if(i.erro)return null;const o=new Set,c=(i.logradouro||"").trim(),r=(i.bairro||"").trim(),a=(i.localidade||"").trim(),u=(i.uf||"").trim();c&&r&&a&&u&&o.add(`${c} ${r} ${a} ${u}`),c&&a&&u&&o.add(`${c} ${a} ${u}`),r&&a&&u&&o.add(`${r} ${a} ${u}`),c&&u&&o.add(`${c} ${u}`),a&&u&&o.add(`${a} ${u}`),a&&u&&o.add(`${a} ${u} Brasil`),c&&r&&a&&u&&o.add(`${c} ${r} ${a} ${u} Brasil`),o.add(t);const h=Array.from(o);for(const p of h){const d=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(p)}&count=1&language=pt`;try{const m=await fetch(d);if(!m.ok)continue;const g=await m.json();if(g.results&&g.results.length>0){const v=g.results[0];return{lat:v.latitude,lon:v.longitude}}}catch{}}try{const l=`https://nominatim.openstreetmap.org/search.php?q=${encodeURIComponent(`${i.localidade||""} ${i.uf||""} Brasil`.trim())}&format=jsonv2&limit=1`,d=await fetch(l,{headers:{"User-Agent":"LavaRapido-App/1.0 (+https://example.local)"}});if(d.ok){const m=await d.json();if(m&&m.length>0&&m[0].lat&&m[0].lon)return{lat:parseFloat(m[0].lat),lon:parseFloat(m[0].lon)}}}catch{}return null}catch{return null}}const Ie="cepCache_v1",We=()=>{try{return JSON.parse(localStorage.getItem(Ie)||"{}")}catch{return{}}},Je=e=>{try{localStorage.setItem(Ie,JSON.stringify(e))}catch{}},D='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" fill="#FFD54A"/><g stroke="#FFD54A" stroke-width="1.2" stroke-linecap="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></g></svg>',M='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 17.58A5.59 5.59 0 0 0 14.42 12H13a4 4 0 1 0-7.9 1.56A4 4 0 0 0 6 20h14a0 0 0 0 0 0-2.42z" fill="#B0BEC5"/></svg>',_='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 17.58A5.59 5.59 0 0 0 14.42 12H13a4 4 0 1 0-7.9 1.56A4 4 0 0 0 6 20h14a0 0 0 0 0 0-2.42z" fill="#90A4AE"/><g stroke="#4FC3F7" stroke-linecap="round" stroke-width="1.5"><path d="M8 21l0-3"/><path d="M12 21l0-3"/><path d="M16 21l0-3"/></g></svg>';async function ie(e,t,n,s){try{const i=window.__BACKEND_URL__||"http://localhost:4000",o=new URL(`${i}/api/visual-weather`);o.searchParams.set("lat",e),o.searchParams.set("lon",t),n&&o.searchParams.set("start",n),s&&o.searchParams.set("end",s);const c=await fetch(o.toString());return c.ok?await c.json():null}catch(i){return console.warn("visual weather fetch failed",i),null}}const $e="weatherCache_v1",Ye=600*1e3,Ge=()=>{try{return JSON.parse(localStorage.getItem($e)||"{}")}catch{return{}}},Qe=e=>{try{localStorage.setItem($e,JSON.stringify(e))}catch{}};async function Xe(e,t){const n=S(),s=(()=>{const a=new Date(n+"T00:00:00");return a.setDate(a.getDate()+1),a.toISOString().split("T")[0]})(),i=`${e.toFixed(4)},${t.toFixed(4)},${n},${s}`,o=Ge(),c=Date.now();if(o[i]&&c-(o[i].ts||0)<Ye)return o[i].data;let r=null;try{const a=await ie(e,t,n,s);a&&a.days&&(r=a)}catch{}if(!r){const a=await Be(n,s,e,t);a&&a.length&&(r={lat:e,lon:t,days:a.map(u=>({date:u.date,conditionSimple:u.label,temp:u.temp||u.tempmax||null}))})}return o[i]={ts:c,data:r},Qe(o),r}async function ce(e=-23.55,t=-46.63){try{const n=document.getElementById("home-weather-cards"),s=document.getElementById("weather-card-today"),i=document.getElementById("weather-card-tomorrow");s&&(s.innerHTML='<div class="title">Hoje</div><div class="cond">Carregando...</div>'),i&&(i.innerHTML='<div class="title">Amanh√£</div><div class="cond">Carregando...</div>');const o=await Xe(e,t);if(!o||!o.days||o.days.length===0){s&&(s.innerHTML='<div class="title">Hoje</div><div class="cond">Indispon√≠vel</div>'),i&&(i.innerHTML='<div class="title">Amanh√£</div><div class="cond">Indispon√≠vel</div>');return}const c=S(),r=(()=>{const l=new Date(c+"T00:00:00");return l.setDate(l.getDate()+1),l.toISOString().split("T")[0]})(),a={};o.days.forEach(l=>{a[l.date]=l});const u=a[c]||o.days[0],h=a[r]||o.days[1]||null,p=(l,d,m)=>{if(!l)return;if(!d){l.innerHTML=`<div class="title">${m}</div><div class="cond">Indispon√≠vel</div>`;return}const g=d.conditionSimple||d.label||d.conditions||""||"Indeterminado",v=Math.round(d.temp||d.tempmax||0),y=g==="Ensolarado"?D:g==="Nublado"?M:g==="Chuvoso"?_:"";l.innerHTML=`
                    <div class="title">${m}</div>
                    <div class="d-flex align-items-center gap-2 mt-1">
                        <div class="icon">${y}</div>
                        <div>
                            <div class="temp">${v}¬∞C</div>
                            <div class="cond">${g}</div>
                        </div>
                    </div>
                `,l.setAttribute("title",`${m}: ${g} ‚Äî ${v}¬∞C`)};p(s,u,"Hoje"),p(i,h,"Amanh√£")}catch(n){console.warn("Failed to render home forecast",n)}}async function Be(e,t,n=-23.55,s=-46.63){const i=`https://api.open-meteo.com/v1/forecast?latitude=${n}&longitude=${s}&start_date=${e}&end_date=${t}&daily=weathercode&timezone=auto`;try{const o=await fetch(i);if(!o.ok)return null;const c=await o.json(),r=h=>h===0?{label:"Ensolarado",icon:"‚òÄÔ∏è"}:[1,2,3].includes(h)?{label:"Nublado",icon:"‚òÅÔ∏è"}:h>=51?{label:"Chuvoso",icon:"üåßÔ∏è"}:{label:"Indeterminado",icon:"‚ùì"},a=c.daily&&c.daily.time||[],u=c.daily&&c.daily.weathercode||[];return a.map((h,p)=>({date:h,...r(u[p]||-1)}))}catch{return null}}async function Le(){const e=je.value||"month",t=se.value||S(),s=qe(e,t,w&&L?L:x);A&&(A.destroy(),A=null);const i=ze.getContext("2d");A=new Chart(i,{type:"bar",data:{labels:s.labels,datasets:[{label:"Ve√≠culos lavados",data:s.counts,backgroundColor:"rgba(6,182,212,0.7)",yAxisID:"y"},{label:"Faturamento (R$)",data:s.revenue,type:"line",borderColor:"rgba(16,185,129,0.9)",backgroundColor:"rgba(16,185,129,0.3)",yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{tooltip:{mode:"index",intersect:!1},legend:{position:"top"}},scales:{x:{ticks:{maxRotation:45,autoSkip:!0,maxTicksLimit:20}},y:{type:"linear",position:"left",title:{display:!0,text:"Ve√≠culos"}},y1:{type:"linear",position:"right",grid:{drawOnChartArea:!1},title:{display:!0,text:"R$"}}}}});let o=t,c=t;if(s.labels&&s.labels.length>1){const l=d=>{if(!d)return t;const m=d.split("/");if(m.length===3){const[v,y,$]=m;return`${$}-${y.padStart(2,"0")}-${v.padStart(2,"0")}`}const g=new Date(d+"T00:00:00");return isNaN(g.getTime())?t:g.toISOString().split("T")[0]};if(e==="year"){const d=new Date(t+"T00:00:00").getFullYear();o=`${d}-01-01`,c=`${d}-12-31`}else o=l(s.labels[0]),c=l(s.labels[s.labels.length-1])}const r=document.getElementById("stats-cep"),a=document.getElementById("stats-cep-feedback");let u=-23.55,h=-46.63;if(a&&(a.classList.add("d-none"),a.textContent=""),r&&r.value){const l=(r.value||"").toString().replace(/\D/g,""),d=We();if(d[l])u=d[l].lat,h=d[l].lon;else{const m=await be(r.value);m?(u=m.lat,h=m.lon,d[l]={lat:u,lon:h,ts:Date.now()},Je(d)):a&&(a.classList.remove("d-none"),a.textContent="N√£o foi poss√≠vel resolver este CEP para coordenadas. Usando local padr√£o.")}}let p=null;try{const l=await ie(u,h,o,c);if(l&&l.days){const d=document.getElementById("stats-weather-strip"),m=document.getElementById("stats-weather-legend"),g=document.getElementById("stats-weather");if(d&&(d.innerHTML=""),m&&(m.innerHTML="Legenda:"),l.days.forEach(v=>{const y=new Date(v.date+"T00:00:00"),$=isNaN(y.getTime())?v.date:y.toLocaleDateString("pt-BR"),I=v.conditionSimple||"",B=I==="Ensolarado"?D:I==="Nublado"?M:I==="Chuvoso"?_:"";if(d){const T=document.createElement("div");T.className="day-icon",T.setAttribute("role","img"),T.setAttribute("aria-label",`${$}: ${I}`),T.title=`${$}: ${v.conditions||I} ${v.precipprob?`(${v.precipprob}% precip)`:""}`,T.innerHTML=`${B}<div class="label">${$}</div>`,d.appendChild(T)}}),m){m.innerHTML="";const v=(y,$)=>{const I=document.createElement("span");return I.innerHTML=`${y}<strong style="margin-left:6px;">${$}</strong>`,I};m.appendChild(v(D,"Ensolarado")),m.appendChild(v(M,"Nublado")),m.appendChild(v(_,"Chuvoso"))}g&&(g.textContent="Previs√£o meteorol√≥gica (Visual Crossing)."),p=l.days}else{const d=await Be(o,c,u,h),m=document.getElementById("stats-weather-strip"),g=document.getElementById("stats-weather-legend"),v=document.getElementById("stats-weather");if(m&&(m.innerHTML=""),g&&(g.innerHTML="Legenda:"),d&&d.length){if(d.forEach(y=>{const $=new Date(y.date+"T00:00:00"),I=isNaN($.getTime())?y.date:$.toLocaleDateString("pt-BR"),B=y.conditionSimple||y.label||"",T=B==="Ensolarado"?D:B==="Nublado"?M:B==="Chuvoso"?_:"";if(m){const R=document.createElement("div");R.className="day-icon",R.setAttribute("role","img"),R.setAttribute("aria-label",`${I}: ${B}`),R.title=`${I}: ${B}`,R.innerHTML=`${T}<div class="label">${I}</div>`,m.appendChild(R)}}),g){g.innerHTML="";const y=($,I)=>{const B=document.createElement("span");return B.innerHTML=`${$}<strong style="margin-left:6px;">${I}</strong>`,B};g.appendChild(y(D,"Ensolarado")),g.appendChild(y(M,"Nublado")),g.appendChild(y(_,"Chuvoso"))}v&&(v.textContent="Previs√£o meteorol√≥gica."),p=d}else{const y=`Coordenadas tentadas: ${u.toFixed(6)}, ${h.toFixed(6)}`,$=a&&!a.classList.contains("d-none")?" / "+(a.textContent||"").trim():"",I=document.getElementById("stats-weather");I&&(I.textContent=`Dados meteorol√≥gicos indispon√≠veis. ${y}${$}`),console.debug("Weather unavailable for",{start:o,end:c,lat:u,lon:h,cepFeedback:a&&a.textContent})}}}catch(l){console.error("Erro ao buscar weather:",l)}try{if(p&&p.length){const l=p.length,d={Ensolarado:0,Nublado:0,Chuvoso:0,Indeterminado:0};p.forEach(v=>{const y=(v.conditionSimple||v.label||v.conditions||"").toString().toLowerCase();y.includes("ensolar")||y.includes("sun")||y.includes("clear")?d.Ensolarado++:y.includes("nublado")||y.includes("cloud")?d.Nublado++:y.includes("chuv")||y.includes("rain")||y.includes("storm")||y.includes("showers")?d.Chuvoso++:d.Indeterminado++});const m=v=>l===0?0:Math.round(v*1e3/l)/10,g=[];g.push(`<div class="me-3">${D} <strong>Ensolarado</strong> ${m(d.Ensolarado)}% (${d.Ensolarado}/${l})</div>`),g.push(`<div class="me-3">${M} <strong>Nublado</strong> ${m(d.Nublado)}% (${d.Nublado}/${l})</div>`),g.push(`<div class="me-3">${_} <strong>Chuvoso</strong> ${m(d.Chuvoso)}% (${d.Chuvoso}/${l})</div>`),d.Indeterminado>0&&g.push(`<div class="me-3">‚ùì <strong>Indeterminado</strong> ${m(d.Indeterminado)}% (${d.Indeterminado}/${l})</div>`),Ee&&(Ee.innerHTML=`<div class="small text-secondary">Distribui√ß√£o meteorol√≥gica (${l} dias):</div><div class="mt-1 d-flex flex-wrap gap-2">${g.join("")}</div>`)}}catch(l){console.warn("Failed to compute weather percentages",l)}try{const l=document.getElementById("home-weather");if(l&&p&&p.length){const d=S(),m=p.find(g=>g.date===d)||p[0];if(m){const g=m.conditionSimple==="Ensolarado"?D:m.conditionSimple==="Nublado"?M:m.conditionSimple==="Chuvoso"?_:"";l.innerHTML=`${g} <strong style="vertical-align:middle;">${m.conditionSimple}</strong> ‚Äî ${Math.round(m.temp||m.tempmax||0)}¬∞C`}}}catch{}}we&&we.addEventListener("click",async()=>{try{const e=document.getElementById("stats-cep");e&&e.value&&localStorage.setItem(G,e.value)}catch{}await Le()});const re=document.getElementById("stats-cep");re&&re.addEventListener("change",()=>{try{localStorage.setItem(G,re.value)}catch{}});const Ce=document.getElementById("stats-export");Ce&&Ce.addEventListener("click",()=>{if(!A)return f("Gere o gr√°fico antes de exportar.","warning");const e=A.data.labels,t=A.data.datasets[0].data,n=A.data.datasets[1].data;let s=`label,veiculos,faturamento
`;for(let r=0;r<e.length;r++)s+=`${e[r]},${t[r]||0},${n[r]||0}
`;const i=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(i),c=document.createElement("a");c.href=o,c.download="estatisticas.csv",document.body.appendChild(c),c.click(),c.remove(),setTimeout(()=>URL.revokeObjectURL(o),1e3)}),oe.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("service-id-hidden").value,n={nome:document.getElementById("serviceName").value,preco:parseFloat(document.getElementById("servicePrice").value),duration:parseInt(document.getElementById("serviceDuration").value)};if(t){const s=b.findIndex(i=>i.id===t);b[s]={...b[s],...n},f(`Servi√ßo "${n.nome}" atualizado.`)}else{const s={...n,id:n.nome.toLowerCase().replace(/\s+/g,"-")+"-"+Date.now()};b.push(s),f(`Servi√ßo "${n.nome}" adicionado.`)}ae(),oe.reset(),document.getElementById("service-id-hidden").value="",document.getElementById("service-form-title").textContent="Adicionar Novo Servi√ßo",document.getElementById("service-form-submit-btn").textContent="Adicionar",document.getElementById("service-form-cancel-btn").classList.add("d-none"),H("services")}),document.getElementById("service-form-cancel-btn").addEventListener("click",()=>{oe.reset(),document.getElementById("service-id-hidden").value="",document.getElementById("service-form-title").textContent="Adicionar Novo Servi√ßo",document.getElementById("service-form-submit-btn").textContent="Adicionar",document.getElementById("service-form-cancel-btn").classList.add("d-none")}),O.value=S(),O.min=S(),N(null);const Ze="e7ec9cbf3dc1a42562a5e500d5768001933624ea8d8f3ea0602092c42d4bc857",et=async e=>{const n=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(s)).map(o=>o.toString(16).padStart(2,"0")).join("")};document.getElementById("admin-password-submit").addEventListener("click",async()=>{const e=document.getElementById("admin-password-input").value||"",t=document.getElementById("admin-password-feedback");t.classList.add("d-none");const n=document.getElementById("admin-password-modal"),s=bootstrap.Modal.getInstance(n),i=window.__BACKEND_URL__||"http://localhost:4000";try{const c=await fetch(`${i}/api/admin/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})});if(c.ok){const r=await c.json();if(r&&r.token){P(r.token),s.hide(),N("admin");return}}}catch(c){console.warn("Backend auth failed, falling back to local check",c)}await et(e)===Ze?(t.classList.add("d-none"),s.hide(),N("admin")):t.classList.remove("d-none")});const Se="a11yPreferences_v1",Q={contrast:!1,largeText:!1,collapsed:!0},xe=()=>{try{return JSON.parse(localStorage.getItem(Se)||JSON.stringify(Q))}catch{return Q}},de=e=>{try{localStorage.setItem(Se,JSON.stringify(e))}catch{}},le=e=>{const t=document.body;t.classList.toggle("a11y-high-contrast",!!e.contrast),t.classList.toggle("a11y-large-text",!!e.largeText),t.classList.toggle("a11y-reduced-motion",!1);const n=document.getElementById("a11y-toolbar");n&&n.classList.toggle("collapsed",!!e.collapsed);const s=document.getElementById("a11y-toggle");s&&s.setAttribute("aria-expanded",String(!e.collapsed));const i=document.getElementById("a11y-contrast"),o=document.getElementById("a11y-large-text");i&&(i.checked=!!e.contrast,i.setAttribute("aria-checked",String(!!e.contrast))),o&&(o.checked=!!e.largeText,o.setAttribute("aria-checked",String(!!e.largeText)))};try{const e=xe();le(e)}catch{}const X=document.getElementById("a11y-contrast"),Z=document.getElementById("a11y-large-text"),Ae=document.getElementById("a11y-reset"),Te=()=>{const e=document.getElementById("a11y-toolbar"),t={contrast:!!(X&&X.checked),largeText:!!(Z&&Z.checked),collapsed:!!(e&&e.classList.contains("collapsed"))};le(t),de(t)};X&&X.addEventListener("change",Te),Z&&Z.addEventListener("change",Te),Ae&&Ae.addEventListener("click",()=>{de(Q),le(Q),f("Prefer√™ncias de acessibilidade restauradas.","success")});const ke=document.getElementById("weather-clear-cache"),De=document.getElementById("weather-test-conn");ke&&ke.addEventListener("click",()=>{try{localStorage.removeItem("weatherCache_v1"),f("Cache meteorol√≥gico limpo.","success")}catch{f("Falha ao limpar cache.","danger")}}),De&&De.addEventListener("click",async()=>{try{f("Testando servi√ßo meteorol√≥gico...","info");const e=await ie(-23.55,-46.63,S(),S());e&&e.days?f("Servi√ßo meteorol√≥gico acess√≠vel.","success"):f("Servi√ßo meteorol√≥gico indispon√≠vel (fallback).","warning")}catch{f("Erro ao testar servi√ßo meteorol√≥gico.","danger")}});const Me=()=>{const e=document.getElementById("a11y-toolbar");if(!e)return;const t=e.classList.toggle("collapsed"),n=xe();n.collapsed=t,de(n);const s=document.getElementById("a11y-toggle");s&&s.setAttribute("aria-expanded",String(!t))},_e=document.getElementById("a11y-toggle");_e&&_e.addEventListener("click",Me),window.addEventListener("keydown",e=>{(e.altKey||e.metaKey)&&(e.key==="m"||e.key==="M")&&(e.preventDefault(),Me())});try{(async()=>{const e=localStorage.getItem(G);if(e){const t=await be(e).catch(()=>null);t?await ce(t.lat,t.lon):await ce()}else await ce()})()}catch(e){console.warn("home forecast init failed",e)}try{window.switchView=N,window.fetchPublicAppointments=W,window.showAdminPasswordModal=()=>{const e=document.getElementById("admin-password-modal");if(!e)return;const t=new bootstrap.Modal(e),n=document.getElementById("admin-password-input");n&&(n.value="");const s=document.getElementById("admin-password-feedback");s&&s.classList.add("d-none"),t.show()}}catch{}});
